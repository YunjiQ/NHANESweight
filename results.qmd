# Results

```{r warning=FALSE, message=FALSE, include = FALSE}
library(ggplot2)
library(dplyr)
# nrow(whq) # 4503
```

## Scatterplot with Contour Line - Height vs. Weight by Gender

We utilize a scatter plot with contour lines to view the fundamental characteristics of heights and weights categorized by gender. Prior to creating the plot, extreme values of weights and heights were identified and removed to mitigate the potential influence of outliers on the overall patterns. The comprehensive plot, encompassing all genders, reveals a positive correlation between height and weight. This correlation aligns with our intuitive understanding: as height increases, so does weight.

The density contour lines play a crucial role in illustrating regions of heightened data point concentration. A prominent cluster dominates the plot, indicating that heights tend to concentrate between 60 and 70 inches, while weights concentrate between 100 and 250 pounds. Noteworthy outliers are present on the plot, with a particularly intriguing observation: the majority of outliers are females with heavier weights.

```{r}
whq1 <- whq |>
  filter(current_height < 100) |>
  filter(current_weight < 600)

ggplot(whq1, aes(current_height, current_weight)) +
  geom_point(alpha = 0.5, aes(color = gender)) +
  geom_density_2d(alpha = 0.5) +
  labs(title = "Height vs. Weight by Gender",
       x = "Current Height",
       y = "Current Weight")
```

## Longitudinal BMI Changes

As we delve deeper into our exploration of health metrics, we turn our attention to Body Mass Index (BMI), a widely used measure that provides insights into the relationship between an individual's weight and height. BMI is a numerical value calculated by dividing an individual's weight in pounds by the square of their height in inches. We use the BMI formula given by CDC to calculate each person's previous and current BMI:

$$
\frac{Weight(lb)}{height(in)^2} \cdot 703
$$

We utilize the following BMI categories ranging from underweight to obese in the chart below:

```{r warning=FALSE, message=FALSE, include = FALSE}
library(dplyr)

# get the bmi
whq <- read.csv("data/whq_handle_missing.csv")

whq$prev_bmi <- round((whq$previous_weight / (whq$current_height^2)) * 703, 2)
whq$curr_bmi <- round((whq$current_weight / (whq$current_height^2)) * 703, 2)

classify_bmi <- function(bmi) {
  if (bmi < 18.5) {
    return('Underweight')
  } else if (bmi >= 18.5 & bmi <= 24.99) {
    return('Healthy Weight')
  } else if (bmi >= 25 & bmi <= 29.99) {
    return('Overweight')
  } else {
    return('Obese')
  }
}

# classify the bmi level
whq$prev_bmi_level <- sapply(whq$prev_bmi, classify_bmi)
whq$curr_bmi_level <- sapply(whq$curr_bmi, classify_bmi)

whq$prev_bmi_level <- factor(whq$prev_bmi_level, 
                        levels = c('Underweight', 'Healthy Weight', 'Overweight', 'Obese'))
whq$curr_bmi_level <- factor(whq$curr_bmi_level, 
                        levels = c('Underweight', 'Healthy Weight', 'Overweight', 'Obese'))

whq$bmi_change <- as.numeric(whq$curr_bmi) - as.numeric(whq$prev_bmi)

whq$bmi_level_change <- ifelse(whq$bmi_change < 0, "lose",
                             ifelse(whq$bmi_change > 0, "gain", "maintain"))

whq$bmi_level_change <- factor(whq$bmi_level_change, 
                        levels = c('lose', 'maintain', 'gain'))

# remove outliers
whq <- whq |>
  filter(age_heaviest_weight < 100) |>
  filter(current_height < 100) |>
  filter(current_weight < 1000) |>
  filter(previous_weight < 1000)

write.csv(whq, "data/whq.csv", row.names = FALSE)
```

## Heatmap - Previous BMI vs. Current BMI

```{r}
ggplot(whq, aes(prev_bmi, curr_bmi)) +
  geom_bin2d(binwidth = c(5, 5)) + 
  ggtitle("Previous BMI vs. Current BMI")
```

## Alluvial - BMI Level Change

```{r}
#| warning: false
library(ggalluvial)

change <- whq |>
      group_by(prev_bmi_level, curr_bmi_level) |>
      summarise(frequency = n(), .groups = 'drop') |>
      rename("Freq" = frequency)

ggplot(change, aes(y = Freq, axis1 = prev_bmi_level, axis2 = curr_bmi_level)) +
      geom_alluvium(aes(fill = prev_bmi_level), width = 1/12) +
      geom_stratum(width = 1/12) +
      geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
      scale_x_discrete(expand = c(0.05, 0.05)) +
      scale_fill_brewer(type = "qual", palette = "RdBu", direction = -1) +
      labs(title = "BMI Level Change") +
      annotate("text", x = 1, y = 0, label = "prev_bmi_level", vjust = 1.5, hjust = 0.5) +
      annotate("text", x = 2, y = 0, label = "curr_bmi_level", vjust = 1.5, hjust = 0.5) +
      theme(axis.title.x = element_blank()) 
```

## Grouped Bar Chart - Current BMI by Age

```{r}
whq$age_group <- cut(whq$age_heaviest_weight,
                     breaks = c(10, 20, 30, 40, 50, 60, 70, 80),
                     labels = c("11-20", "21-30", "31-40", "41-50", "51-60", "61-70", "71-80"),
                     include.lowest = TRUE)

whq$curr_bmi_level <- factor(whq$curr_bmi_level, 
                        levels = c('Underweight', 'Healthy Weight', 'Overweight', 'Obese'))

ggplot(whq, aes(x = curr_bmi_level, fill = curr_bmi_level)) + 
  geom_bar() + 
  scale_fill_brewer(name = "Levels", palette = "YlOrRd") + 
  facet_grid(. ~ age_group ) +
  scale_x_discrete(name = "BMI Level") + 
  scale_y_continuous(name = "Counts") +
  ggtitle('Current BMI Level by Age') +
  theme(plot.title = element_text(hjust = 0.5, size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1)) 

```



## Violin Plot - BMI Distribution by Race

```{r fig.width=12, fig.height=8}
library(ggplot2)

ggplot(whq, aes(x = curr_bmi, y = race, fill = race)) + 
  geom_violin(trim=FALSE) +
  geom_boxplot(width=0.1, fill="white") +
  labs(title="BMI Distribution among Race",x="BMI", y = "Race") +
  scale_fill_brewer(palette="Set3")
```

## Pyramid Chart - Age of the Heaviest Weight Distribution by Gender

```{r warning=FALSE, message=FALSE}
# min(whq$age_heaviest_weight) # 12
# max(whq$age_heaviest_weight) # 99999
# nrow(whq[whq$age_heaviest_weight > 80, ]) # 21  

whq$age_group <- cut(whq$age_heaviest_weight,
                     breaks = c(10, 20, 30, 40, 50, 60, 70, 80),
                     labels = c("11-20", "21-30", "31-40", "41-50", "51-60", "61-70", "71-80"),
                     include.lowest = TRUE)

plot_data <- whq %>%
  group_by(age_group, gender) %>%
  summarise(count = n()) %>%
  ungroup()

plot_data$count[plot_data$gender == "female"] <- -plot_data$count[plot_data$gender == "female"]

ggplot(plot_data, aes(x = count, y = age_group, fill = gender)) +
  geom_bar(stat = "identity", position = "identity", color = "black", alpha = 0.7) +
  geom_text(aes(label = abs(count), hjust = ifelse(count < 0, 1.1, -0.1)), color = "black", size = 3) +
  labs(title = "Age Distribution by Gender",
       x = "Position",
       y = "Count") +
  scale_x_continuous(labels = abs) + 
  theme_minimal()
```


## Correlation Analysis Between Factors and BMI Change

-   Dieting and BMI

    ```{r warning=FALSE, fig.width=12, fig.height=8}
    library(grid)
    library(vcd)
    library(RColorBrewer)

    # mosaic plot
    dieting_sub_df <- whq |>
      group_by(bmi_level_change, eat_less, skip_meal, low_cal) |>
      summarise(frequency = n(), .groups = 'drop') |>
      rename("Freq" = frequency)

    mosaic(bmi_level_change ~ eat_less + skip_meal + low_cal, dieting_sub_df , direction = c("v", "v", "h", "h"),
           highlighting_fill= rev(brewer.pal(3, "RdBu")),
           rot_labels = 0,
           margins = c(5, 10, 10, 10),
           main = "Mosaic plot for Dieting and BMI")

    ```

-   Dietary Preferences

    ```{r warning=FALSE, fig.width=10}
    library(ggalluvial)

    preference_sub_df <- whq |>
      group_by(bmi_level_change, more_vege, less_sugar, fewer_carb, less_fat) |>
      summarise(frequency = n(), .groups = 'drop') |>
      rename("Freq" = frequency)

    ggplot(preference_sub_df, aes(y = Freq, axis1 = more_vege, axis2 = less_sugar, axis3 = fewer_carb, axis4 = less_fat)) +
      geom_alluvium(aes(fill = bmi_level_change), width = 1/12) +
      geom_stratum(width = 1/12) +
      geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
      scale_x_discrete(expand = c(0.05, 0.05)) +
      scale_fill_brewer(type = "qual", palette = "RdBu", direction = -1) +
      labs(title = "Alluvium Plot for Dietary Preferences and BMI Change") +
      annotate("text", x = 1, y = 0, label = "More Vegetables", vjust = 1.5, hjust = 0.5) +
      annotate("text", x = 2, y = 0, label = "Less Sugar", vjust = 1.5, hjust = 0.5) +
      annotate("text", x = 3, y = 0, label = "Fewer Carbs", vjust = 1.5, hjust = 0.5) +
      annotate("text", x = 4, y = 0, label = "Less Fat", vjust = 1.5, hjust = 0.5) +
      theme(axis.title.x = element_blank()) 
    ```
